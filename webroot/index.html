<!doctype html>
<html lang="en">
  <head>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta charset="UTF-8" />
    <title>Where's the Shape?</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <!-- Loading overlay -->
    <div id="loading-overlay" class="loading-overlay">
      <div class="loader">
        <div class="shape-loader square"></div>
        <div class="shape-loader circle"></div>
        <div class="shape-loader triangle"></div>
        <div class="shape-loader star"></div>
      </div>
      <p>Loading game...</p>
    </div>
    
    <div class="game-container">
      <h1>Click anywhere on the canvas to place shape</h1>
      <div id="game-instructions" class="instructions"></div>
      
      <div class="game-layout">
        <div class="left-column">
          <div id="game-canvas-container">
            <!-- Stack canvases in the correct z-index order -->
            <canvas id="shape-cloud" width="350" height="350" data-role="background-shapes"></canvas>
            <canvas id="heatmap-layer" width="350" height="350" data-role="heatmap"></canvas>
            <canvas id="interaction-layer" width="350" height="350" data-role="interaction"></canvas>
          </div>
          
          <div class="canvas-buttons">
            <button id="regenerate-shapes" class="secondary-btn needs-attention" style="display: none;">
              <span>Create Background</span>
            </button>
            <button id="create-new-game" class="action-btn" style="display: none;">
              <span>Create Game</span>
            </button>
            
            <button id="regenerate-shapes-creator" class="secondary-btn needs-attention" style="display: none;">
              <span>Create Background</span>
            </button>
            <button id="submit-hidden-shape" class="action-btn" style="display: none;">
              <span>Create Game</span>
            </button>
          </div>
        </div>
        
        <div class="game-controls">
          <!-- Hub Post Controls -->
          <div id="hub-controls" class="controls-container" style="display: none;">
            <h3>Shape</h3>
            <div class="shape-selector">
              <button data-shape="square" class="shape-btn active" aria-label="Square shape">
                <div class="shape-icon square"></div>
              </button>
              <button data-shape="circle" class="shape-btn" aria-label="Circle shape">
                <div class="shape-icon circle"></div>
              </button>
              <button data-shape="triangle" class="shape-btn" aria-label="Triangle shape">
                <div class="shape-icon triangle"></div>
              </button>
              <button data-shape="star" class="shape-btn" aria-label="Star shape">
                <div class="shape-icon star"></div>
              </button>
            </div>
            
            <h3>Color</h3>
            <div class="color-selector">
              <button data-color="red" class="color-btn active" style="background-color: #ff6b6b;" aria-label="Red color"></button>
              <button data-color="blue" class="color-btn" style="background-color: #4dabf7;" aria-label="Blue color"></button>
              <button data-color="green" class="color-btn" style="background-color: #69db7c;" aria-label="Green color"></button>
              <button data-color="yellow" class="color-btn" style="background-color: #ffd43b;" aria-label="Yellow color"></button>
              <button data-color="purple" class="color-btn" style="background-color: #b197fc;" aria-label="Purple color"></button>
            </div>
            
            <h3>Size</h3>
            <div class="shape-size-control">
              <input type="range" id="hub-shape-size" min="30" max="60" value="30" class="size-slider" aria-label="Shape size slider">
              <span id="hub-shape-size-value">30</span>
            </div>
          </div>
          
          <!-- Game Creator Controls -->
          <div id="creator-controls" class="controls-container" style="display: none;">
            <h3>Shape</h3>
            <div class="shape-selector">
              <button data-shape="square" class="shape-btn active" aria-label="Square shape">
                <div class="shape-icon square"></div>
              </button>
              <button data-shape="circle" class="shape-btn" aria-label="Circle shape">
                <div class="shape-icon circle"></div>
              </button>
              <button data-shape="triangle" class="shape-btn" aria-label="Triangle shape">
                <div class="shape-icon triangle"></div>
              </button>
              <button data-shape="star" class="shape-btn" aria-label="Star shape">
                <div class="shape-icon star"></div>
              </button>
            </div>
            
            <h3>Color</h3>
            <div class="color-selector">
              <button data-color="red" class="color-btn active" style="background-color: #ff6b6b;" aria-label="Red color"></button>
              <button data-color="blue" class="color-btn" style="background-color: #4dabf7;" aria-label="Blue color"></button>
              <button data-color="green" class="color-btn" style="background-color: #69db7c;" aria-label="Green color"></button>
              <button data-color="yellow" class="color-btn" style="background-color: #ffd43b;" aria-label="Yellow color"></button>
              <button data-color="purple" class="color-btn" style="background-color: #b197fc;" aria-label="Purple color"></button>
            </div>
            
            <h3>Size</h3>
            <div class="shape-size-control">
              <input type="range" id="creator-shape-size" min="10" max="60" value="24" class="size-slider" aria-label="Shape size slider">
              <span id="creator-shape-size-value">24</span>
            </div>
          </div>
          
          <div id="guesser-controls" class="controls-container" style="display: none;">
            <h3>Find the hidden <span id="hidden-shape-name">shape</span>!</h3>
            <p>Click on where you think the shape is hidden among all the others. You have 5 seconds to find it!</p>
            <div class="timer-container">
              <div id="timer-bar"><div id="timer-progress"></div></div>
              <div id="timer-text">5</div>
            </div>
            <p id="guess-count">Total guesses: 0</p>
          </div>
          
          <div id="results-controls" class="controls-container" style="display: none;">
            <h3>The hidden <span id="revealed-shape-name">shape</span> is revealed!</h3>
            <p id="total-guesses">Total guesses: 0</p>
            <div id="stats-container" style="display: none;">
              <div class="stat">
                <h4>Success Rate</h4>
                <p id="correct-percentage">0%</p>
              </div>
            </div>
            <button id="back-to-guessing" class="secondary-btn" style="display: none;">Back to Guessing</button>
          </div>
        </div>
      </div>
      
      <div id="notification" class="notification" style="display: none;"></div>
    </div>
    <script type="module" src="js/index.js"></script>
    <script>
      // Handle visibility of buttons based on which mode is active
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded - initializing button visibility');
        
        // Force buttons to be displayed initially
        function forceInitialButtonDisplay() {
          const canvasButtons = document.querySelector('.canvas-buttons');
          if (canvasButtons) {
            canvasButtons.style.display = 'flex';
            console.log('Forced canvas buttons container to display flex');
          }
          
          // Check if hub or creator are active
          const hubControls = document.getElementById('hub-controls');
          const creatorControls = document.getElementById('creator-controls');
          
          const hubActive = hubControls && getComputedStyle(hubControls).display !== 'none';
          const creatorActive = creatorControls && getComputedStyle(creatorControls).display !== 'none';
          
          // Explicitly set button visibility based on active mode
          if (hubActive) {
            console.log('Hub mode active, showing hub buttons');
            const regenerateBtn = document.getElementById('regenerate-shapes');
            const createBtn = document.getElementById('create-new-game');
            
            if (regenerateBtn) {
              regenerateBtn.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important;';
            }
            if (createBtn) {
              createBtn.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important;';
            }
          } else if (creatorActive) {
            console.log('Creator mode active, showing creator buttons');
            const regenerateBtn = document.getElementById('regenerate-shapes-creator');
            const submitBtn = document.getElementById('submit-hidden-shape');
            
            if (regenerateBtn) {
              regenerateBtn.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important;';
            }
            if (submitBtn) {
              submitBtn.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important;';
            }
          }
        }
        
        // Function to sync the visibility of buttons
        function syncButtonVisibility() {
          try {
            const hubControls = document.getElementById('hub-controls');
            const creatorControls = document.getElementById('creator-controls');
            const hubControlsVisible = hubControls && getComputedStyle(hubControls).display !== 'none';
            const creatorControlsVisible = creatorControls && getComputedStyle(creatorControls).display !== 'none';
            
            console.log('Mode visibility:', { hubControlsVisible, creatorControlsVisible });
            
            // Get button elements
            const regenerateShapesBtn = document.getElementById('regenerate-shapes');
            const createNewGameBtn = document.getElementById('create-new-game');
            const regenerateShapesCreatorBtn = document.getElementById('regenerate-shapes-creator');
            const submitHiddenShapeBtn = document.getElementById('submit-hidden-shape');
            
            // Set explicit display style for all buttons based on active mode
            if (regenerateShapesBtn) regenerateShapesBtn.style.display = hubControlsVisible ? 'block' : 'none';
            if (createNewGameBtn) createNewGameBtn.style.display = hubControlsVisible ? 'block' : 'none';
            if (regenerateShapesCreatorBtn) regenerateShapesCreatorBtn.style.display = creatorControlsVisible ? 'block' : 'none';
            if (submitHiddenShapeBtn) submitHiddenShapeBtn.style.display = creatorControlsVisible ? 'block' : 'none';
            
            // Force the canvas-buttons container to display: flex to ensure buttons are visible
            const canvasButtons = document.querySelector('.canvas-buttons');
            if (canvasButtons) {
              canvasButtons.style.display = (hubControlsVisible || creatorControlsVisible) ? 'flex' : 'none';
              console.log('Canvas buttons container display set to:', canvasButtons.style.display);
            }
          } catch (error) {
            console.error('Error syncing button visibility:', error);
          }
        }
        
        // Run force display immediately
        forceInitialButtonDisplay();
        
        // Run visibility sync with slight delay to ensure all elements are loaded
        setTimeout(syncButtonVisibility, 100);
        
        // Create a mutation observer to watch for changes in display style
        const observer = new MutationObserver(function(mutations) {
          console.log('Mutation observed, syncing button visibility');
          syncButtonVisibility();
        });
        
        // Observe all control containers for style changes
        const hubControls = document.getElementById('hub-controls');
        const creatorControls = document.getElementById('creator-controls');
        const guesserControls = document.getElementById('guesser-controls');
        const resultsControls = document.getElementById('results-controls');
        
        if (hubControls) observer.observe(hubControls, { attributes: true, attributeFilter: ['style'] });
        if (creatorControls) observer.observe(creatorControls, { attributes: true, attributeFilter: ['style'] });
        if (guesserControls) observer.observe(guesserControls, { attributes: true, attributeFilter: ['style'] });
        if (resultsControls) observer.observe(resultsControls, { attributes: true, attributeFilter: ['style'] });
        
        // Listen for custom event to force button visibility update
        document.addEventListener('custom-mode-change', function() {
          console.log('Custom mode change event received');
          syncButtonVisibility();
          forceInitialButtonDisplay(); // Also run force display when mode changes
        });
        
        // Force initial button visibility after a delay
        setTimeout(function() {
          // Force display again
          forceInitialButtonDisplay();
          
          // Set initial visibility based on current active mode
          syncButtonVisibility();
        }, 500);
        
        // Run one final check after full page load
        window.addEventListener('load', function() {
          console.log('Window loaded, final button visibility check');
          forceInitialButtonDisplay();
          syncButtonVisibility();
        });
        
        // Handle responsive canvas sizing
        function resizeCanvases() {
          const container = document.getElementById('game-canvas-container');
          if (!container) return;
          
          const canvases = container.querySelectorAll('canvas');
          const containerWidth = container.clientWidth;
          const containerHeight = container.clientHeight;
          
          canvases.forEach(canvas => {
            // Update canvas size attributes for smaller screens while maintaining aspect ratio
            if (window.innerWidth <= 350) {
              // For very small screens
              canvas.width = containerWidth;
              canvas.height = containerWidth; // Keep square aspect ratio
            } else {
              // Reset to default for larger screens
              canvas.width = 350;
              canvas.height = 350;
            }
          });
        }
        
        // Resize canvases on page load and when window is resized
        window.addEventListener('resize', resizeCanvases);
        window.addEventListener('load', resizeCanvases);
      });
      
      // Fallback for loading overlay in case the game initialization doesn't trigger
      window.addEventListener('load', function() {
        // Wait a bit before attempting to hide the overlay as a fallback
        setTimeout(function() {
          const loadingOverlay = document.getElementById('loading-overlay');
          if (loadingOverlay && !loadingOverlay.classList.contains('fade-out')) {
            console.log('Fallback: Hiding loading overlay');
            loadingOverlay.classList.add('fade-out');
            setTimeout(() => {
              loadingOverlay.style.display = 'none';
            }, 500);
          }
        }, 2000); // Give the game 2 seconds to initialize on its own
      });
    </script>
  </body>
</html> 